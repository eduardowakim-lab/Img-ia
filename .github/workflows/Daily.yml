import re
from html import unescape

def _clean_html(s: str) -> str:
    if not s: return ""
    s = unescape(s)
    s = re.sub(r"<br\s*/?>", "\n", s, flags=re.I)
    s = re.sub(r"<.*?>", "", s)
    return re.sub(r"\s+\n", "\n", s).strip()

def fetch_top_news():
    url = (f"https://news.google.com/rss/search?q={quote_plus(NEWS_QUERY)}&hl=pt-BR&gl=BR&ceid=BR:pt-419"
           if NEWS_QUERY else
           "https://news.google.com/rss?hl=pt-BR&gl=BR&ceid=BR:pt-419")
    print(f"[news] Feed: {url}")
    r = requests.get(url, timeout=(10,30)); r.raise_for_status()
    feed = feedparser.parse(r.content)
    if not feed.entries:
        raise SystemExit("Não foi possível obter notícias.")

    e = feed.entries[0]
    title   = _clean_html((e.get("title") or "").strip())
    summary = _clean_html((e.get("summary") or e.get("description") or getattr(e, "summary_detail", {}).get("value", "") or "").strip())
    link    = (e.get("link") or "").strip()

    return {"title": title, "summary": summary, "link": link}
